<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI English Tutor v2.4 (Segmentation Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        ::selection { background-color: #fef08a; color: #000; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { BookOpen, CheckCircle, GraduationCap, ArrowRight, ArrowLeft, RefreshCcw, Type, Languages, Brain, ChevronDown, ClipboardList, Award, Link as LinkIcon, Download, Save, Trash2, List, Settings, Key, Eye, EyeOff, Cloud, CloudLightning, Search, PlusCircle, X, AlertTriangle } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, collection, addDoc, deleteDoc, query, onSnapshot, setDoc, getDoc, doc } from 'firebase/firestore';

        // ⚠️ Firebase Config (若無則使用 LocalStorage)
        const firebaseConfig = {
            apiKey: "AIzaSyA14c5Rjzun6C33DWiMmpyKNfXZ2BC6lso",
            authDomain: "ai-english-tutor-f2a01.firebaseapp.com",
            projectId: "ai-english-tutor-f2a01",
            storageBucket: "ai-english-tutor-f2a01.firebasestorage.app",
            messagingSenderId: "404894794284",
            appId: "1:404894794284:web:28fa60b12a486715990789",
            measurementId: "G-6RC6GV81E3"
        };
        
        const APP_ID_TAG = "ai-tutor-v2-fix";
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        const defaultApiKey = ""; 

        // --- API Helpers (With Timeout) ---
        async function generateContent(prompt, systemInstruction = "", userApiKey = null, temperature = 0.7) {
            const keyToUse = userApiKey || defaultApiKey;
            if (!keyToUse) throw new Error("請先設定 Gemini API Key");

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${keyToUse}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json", temperature: temperature }
            };
            if (systemInstruction) payload.systemInstruction = { parts: [{ text: systemInstruction }] };

            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), 20000); // 20s timeout

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                clearTimeout(id);

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                return JSON.parse(text.replace(/^```json\s*/, '').replace(/\s*```$/, ''));
            } catch (error) {
                clearTimeout(id);
                if (error.name === 'AbortError') throw new Error("連線逾時，請重試。");
                throw error;
            }
        }

        async function generateTextContent(prompt, userApiKey = null) {
            const keyToUse = userApiKey || defaultApiKey;
            if (!keyToUse) throw new Error("No API Key");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${keyToUse}`;
            
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), 30000); // 30s timeout

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.1 } 
                    }),
                    signal: controller.signal
                });
                clearTimeout(id);
                if (!response.ok) throw new Error("API Failed");
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
            } catch (error) {
                clearTimeout(id);
                throw error;
            }
        }

        // --- Error/Loading UI ---
        const LoadingView = ({ text, onRetry, error }) => (
            <div className="flex flex-col items-center justify-center py-12 text-slate-500 animate-in fade-in">
                {error ? (
                    <div className="text-center">
                        <div className="bg-red-100 p-4 rounded-full inline-block mb-3 text-red-500"><AlertTriangle size={32} /></div>
                        <p className="text-red-600 font-bold mb-2">{error}</p>
                        <button onClick={onRetry} className="bg-red-600 text-white px-6 py-2 rounded-full font-bold hover:bg-red-700 shadow-lg flex items-center gap-2 mx-auto"><RefreshCcw size={16} /> 重試</button>
                    </div>
                ) : (
                    <>
                        <Brain size={48} className="mb-4 text-blue-600 animate-pulse" />
                        <p className="text-lg font-medium font-sans">{text || "AI 導師正在分析..."}</p>
                    </>
                )}
            </div>
        );

        function EnglishCramSchool() {
            // --- State ---
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [localVocab, setLocalVocab] = useState([]);
            
            // Persistent State (Auto-save)
            const [phase, setPhase] = useState('setup');
            const [userLevel, setUserLevel] = useState('HKDSE Level 2 (A2-B1)');
            const [articleText, setArticleText] = useState('');
            const [segments, setSegments] = useState([]);
            const [currentSegmentIndex, setCurrentSegmentIndex] = useState(0);
            const [segmentAnalyses, setSegmentAnalyses] = useState({});
            
            // UI State
            const [urlInput, setUrlInput] = useState('');
            const [userApiKey, setUserApiKey] = useState('');
            const [keyLoaded, setKeyLoaded] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [showApiKey, setShowApiKey] = useState(false);
            const [loading, setLoading] = useState(false);
            const [fetchError, setFetchError] = useState(null); 
            const [fetchingUrl, setFetchingUrl] = useState(false);
            
            const [selection, setSelection] = useState(null);
            const [analyzingSelection, setAnalyzingSelection] = useState(false);
            const [hasSavedSession, setHasSavedSession] = useState(false);

            // --- Init & Restore ---
            useEffect(() => {
                const savedKey = localStorage.getItem('gemini_api_key');
                if (savedKey) { setUserApiKey(savedKey); setKeyLoaded(true); }

                const savedVocab = localStorage.getItem('local_vocab_db');
                if (savedVocab) setLocalVocab(JSON.parse(savedVocab));

                const savedSession = localStorage.getItem('current_session');
                if (savedSession) setHasSavedSession(true);

                try {
                    if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "你的_API_KEY") {
                        const app = initializeApp(firebaseConfig);
                        const auth = getAuth(app);
                        const firestore = getFirestore(app);
                        setDb(firestore);
                        signInAnonymously(auth).catch(() => {});
                        onAuthStateChanged(auth, (u) => setUser(u));
                    }
                } catch (e) { console.warn("Firebase skipped"); }
            }, []);

            useEffect(() => {
                if (phase === 'classroom' && articleText) {
                    const data = { phase, userLevel, articleText, segments, currentSegmentIndex, segmentAnalyses, timestamp: Date.now() };
                    localStorage.setItem('current_session', JSON.stringify(data));
                }
            }, [phase, articleText, segments, currentSegmentIndex, segmentAnalyses]);

            const restoreSession = () => {
                const saved = localStorage.getItem('current_session');
                if (saved) {
                    const d = JSON.parse(saved);
                    setPhase(d.phase);
                    setUserLevel(d.userLevel);
                    setArticleText(d.articleText);
                    setSegments(d.segments);
                    setCurrentSegmentIndex(d.currentSegmentIndex);
                    setSegmentAnalyses(d.segmentAnalyses);
                    setHasSavedSession(false);
                }
            };

            const clearSession = () => {
                localStorage.removeItem('current_session');
                setHasSavedSession(false);
                setArticleText('');
            };

            const saveApiKey = () => {
                localStorage.setItem('gemini_api_key', userApiKey);
                setKeyLoaded(true);
                setIsSettingsOpen(false);
            };

            // Vocab Logic
            const saveWord = async (wordData) => {
                const newWord = { ...wordData, id: Date.now().toString(), timestamp: Date.now() };
                const updated = [newWord, ...localVocab];
                setLocalVocab(updated);
                localStorage.setItem('local_vocab_db', JSON.stringify(updated));
                if (user && db) {
                    try { await addDoc(collection(db, 'artifacts', APP_ID_TAG, 'users', user.uid, 'vocabulary'), newWord); } catch(e){}
                }
            };

            const deleteWord = async (id) => {
                const updated = localVocab.filter(w => w.id !== id);
                setLocalVocab(updated);
                localStorage.setItem('local_vocab_db', JSON.stringify(updated));
                if (user && db) {
                    try { await deleteDoc(doc(db, 'artifacts', APP_ID_TAG, 'users', user.uid, 'vocabulary', id)); } catch(e){}
                }
            };

            useEffect(() => {
                if (user && db) {
                    const q = collection(db, 'artifacts', APP_ID_TAG, 'users', user.uid, 'vocabulary');
                    return onSnapshot(q, (snap) => {
                        const words = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        if (words.length > 0) setLocalVocab(words.sort((a,b) => b.timestamp - a.timestamp));
                    });
                }
            }, [user, db]);

            // --- Features ---

            const fetchArticle = async () => {
                if (!urlInput.trim()) return;
                setFetchingUrl(true);
                try {
                    let html = null;
                    try { const r = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(urlInput)}`); if(r.ok) html = (await r.json()).contents; } catch(e){}
                    if(!html) { try { const r = await fetch(`https://corsproxy.io/?${encodeURIComponent(urlInput)}`); if(r.ok) html = await r.text(); } catch(e){} }
                    
                    if (!html) throw new Error("無法抓取網頁，請手動複製。");
                    
                    // FIXED PROMPT: Enforce Paragraph Structure
                    const prompt = `
                        Extract the article content from the HTML below. 
                        **CRITICAL:** You MUST separate each paragraph with TWO newlines (\\n\\n). 
                        Do NOT merge paragraphs. Do NOT summarize.
                        HTML: ${html.slice(0, 150000)}
                    `;
                    const text = await generateTextContent(prompt, userApiKey);
                    
                    if (!text || text.length < 50) throw new Error("提取內容過少");
                    setArticleText(text.trim());
                } catch (e) { alert("抓取失敗: " + e.message); }
                setFetchingUrl(false);
            };

            const startClass = () => {
                if (!articleText.trim()) return;
                
                // Smart Splitting Logic
                let raw = articleText.split(/\n\s*\n/); // Try splitting by double newline first
                
                // Fallback: If only 1 segment found (AI failed to split), try single newline but filter short noise
                if (raw.length <= 1) {
                    raw = articleText.split(/\n/).filter(s => s.trim().length > 30); // Only keep lines > 30 chars
                } else {
                    raw = raw.filter(s => s.trim().length > 0);
                }

                if (raw.length === 0) {
                    alert("無法分段，請檢查文章格式");
                    return;
                }

                setSegments(raw);
                setPhase('classroom');
                setCurrentSegmentIndex(0);
                setSegmentAnalyses({});
            };

            const analyzeSegment = async () => {
                if (segmentAnalyses[currentSegmentIndex]) return;
                
                setLoading(true);
                setFetchError(null);
                
                try {
                    const prompt = `
                        Analyze for ${userLevel}: "${segments[currentSegmentIndex]}"
                        Return JSON:
                        {
                            "vocab": [{ "word": "word", "pos": "pos", "meaning_zh": "chi", "note": "eng def" }],
                            "grammar": { "title": "point", "explanation": "chi" },
                            "translation": "chi"
                        }
                        Max 4 words.
                    `;
                    const res = await generateContent(prompt, "", userApiKey, 0.7);
                    setSegmentAnalyses(prev => ({...prev, [currentSegmentIndex]: res}));
                } catch (e) { 
                    console.error(e);
                    setFetchError(e.message); 
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => { if (phase === 'classroom') analyzeSegment(); }, [phase, currentSegmentIndex]);

            // Highlight Logic
            const handleTextSelection = () => {
                const sel = window.getSelection();
                if (!sel || sel.isCollapsed) return;
                const text = sel.toString().trim();
                if (text.length === 0 || text.length > 50) { setSelection(null); return; }
                const rect = sel.getRangeAt(0).getBoundingClientRect();
                setSelection({ text, x: rect.left + window.scrollX + rect.width / 2, y: rect.top + window.scrollY - 10 });
            };

            const saveHighlight = async () => {
                if (!selection) return;
                setAnalyzingSelection(true);
                try {
                    const prompt = `Analyze word "${selection.text}" for ${userLevel}. JSON: {"word":"${selection.text}", "pos":"", "meaning_zh":"", "note":""}`;
                    const res = await generateContent(prompt, "", userApiKey);
                    await saveWord(res);
                    setSelection(null);
                } catch(e) { alert("分析失敗: " + e.message); }
                setAnalyzingSelection(false);
            };

            // --- Views ---

            if (phase === 'setup') {
                return (
                    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 p-6 flex items-center justify-center">
                        <div className="max-w-3xl w-full bg-white rounded-xl shadow-lg p-8 border border-slate-200">
                            
                            {hasSavedSession && (
                                <div className="mb-6 bg-blue-50 border border-blue-200 p-4 rounded-lg flex justify-between items-center animate-pulse">
                                    <span className="text-blue-800 font-bold flex gap-2"><RefreshCcw/> 發現未完成的課程</span>
                                    <div className="flex gap-2">
                                        <button onClick={clearSession} className="text-slate-500 text-sm hover:underline">放棄</button>
                                        <button onClick={restoreSession} className="bg-blue-600 text-white px-4 py-1 rounded shadow hover:bg-blue-700">繼續</button>
                                    </div>
                                </div>
                            )}

                            <div className="text-center mb-8 relative">
                                <div className="absolute top-0 right-0 flex gap-2">
                                    <button onClick={() => setIsSettingsOpen(!isSettingsOpen)} className={`text-sm px-3 py-1 rounded-full font-bold border flex gap-1 ${keyLoaded ? 'bg-green-50 text-green-700' : 'bg-slate-100'}`}>
                                        <Settings size={14}/> {keyLoaded ? "API OK" : "Set Key"}
                                    </button>
                                    <button onClick={() => setPhase('vocab_bank')} className="text-sm bg-amber-50 text-amber-800 border border-amber-200 px-3 py-1 rounded-full font-bold flex gap-1">
                                        <BookOpen size={14} /> 單字庫
                                    </button>
                                </div>
                                <div className="bg-blue-100 p-3 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4"><GraduationCap size={32} className="text-blue-600" /></div>
                                <h1 className="text-3xl font-bold text-slate-800 mb-2">AI 英文補習班 v2.4</h1>
                                <p className="text-slate-500">Segmentation Fix Edition</p>
                            </div>

                            {isSettingsOpen && (
                                <div className="mb-6 bg-slate-800 p-4 rounded-lg text-white">
                                    <div className="flex gap-2 mb-2"><Key size={16}/> API Key</div>
                                    <input type={showApiKey?"text":"password"} value={userApiKey} onChange={e=>setUserApiKey(e.target.value)} className="w-full p-2 rounded bg-slate-700 text-sm mb-2" placeholder="Paste Key..." />
                                    <div className="flex justify-end gap-2">
                                        <button onClick={()=>setShowApiKey(!showApiKey)} className="text-xs text-slate-400">顯示/隱藏</button>
                                        <button onClick={saveApiKey} className="bg-blue-600 px-3 py-1 rounded text-sm">儲存</button>
                                    </div>
                                </div>
                            )}

                            <div className="space-y-6">
                                <select value={userLevel} onChange={(e) => setUserLevel(e.target.value)} className="w-full p-3 rounded-lg border focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option>HKDSE Level 2 (A2-B1)</option>
                                    <option>HKDSE Level 3 (B1-B2)</option>
                                    <option>HKDSE Level 4 (B2)</option>
                                    <option>HKDSE Level 5+ (C1)</option>
                                </select>

                                <div className="bg-slate-50 p-4 rounded-lg border">
                                    <div className="flex gap-2">
                                        <input type="text" value={urlInput} onChange={(e) => setUrlInput(e.target.value)} placeholder="https://..." className="flex-1 p-3 rounded-lg border outline-none" />
                                        <button onClick={fetchArticle} disabled={fetchingUrl} className="bg-blue-500 text-white px-4 rounded-lg font-bold flex gap-2 items-center">
                                            {fetchingUrl ? <RefreshCcw className="animate-spin" size={18}/> : <Download size={18}/>} 抓取
                                        </button>
                                    </div>
                                </div>

                                <textarea value={articleText} onChange={(e) => setArticleText(e.target.value)} placeholder="或在此貼上文章..." className="w-full h-48 p-4 rounded-lg border focus:ring-2 focus:ring-blue-500 outline-none resize-none font-mono text-sm" />

                                <button onClick={startClass} disabled={!articleText.trim()} className="w-full bg-blue-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-blue-700 shadow-lg disabled:bg-slate-300 transition-all flex justify-center items-center gap-2">
                                    <BookOpen size={20} /> 開始上課
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (phase === 'classroom') {
                const data = segmentAnalyses[currentSegmentIndex];
                
                if (loading || (!data && !fetchError)) return <div className="min-h-screen bg-slate-50 font-sans p-6"><div className="max-w-4xl mx-auto"><LoadingView /></div></div>;
                if (fetchError && !data) return <div className="min-h-screen bg-slate-50 font-sans p-6"><div className="max-w-4xl mx-auto"><LoadingView error={fetchError} onRetry={analyzeSegment} /></div></div>;

                return (
                    <div className="min-h-screen bg-slate-50 font-sans text-slate-800" onClick={() => setSelection(null)}>
                        <div className="max-w-4xl mx-auto p-6 relative">
                            {selection && (
                                <div className="fixed z-50 bg-slate-900 text-white p-2 rounded shadow-xl flex gap-2 transform -translate-x-1/2 -translate-y-full" style={{ left: selection.x, top: selection.y }} onClick={e => e.stopPropagation()}>
                                    <span className="font-bold border-r border-slate-600 pr-2">{selection.text}</span>
                                    <button onClick={saveHighlight} disabled={analyzingSelection} className="flex gap-1 items-center hover:text-blue-300 text-sm font-bold">
                                        {analyzingSelection ? <RefreshCcw className="animate-spin" size={14}/> : <PlusCircle size={14}/>} Add
                                    </button>
                                </div>
                            )}

                            <header className="flex justify-between items-center mb-6 border-b pb-4">
                                <h2 className="text-xl font-bold flex items-center gap-2 text-blue-900"><Brain className="text-blue-600" /> Segmented Teaching</h2>
                                <button onClick={()=>{setPhase('setup'); clearSession();}} className="text-xs text-red-400 hover:text-red-600">結束課程</button>
                            </header>

                            <div className="w-full bg-gray-200 rounded-full h-2.5 mb-6"><div className="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style={{ width: `${((currentSegmentIndex + 1) / segments.length) * 100}%` }}></div></div>

                            <div className="grid md:grid-cols-2 gap-8">
                                <div className="space-y-6">
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative group" onMouseUp={handleTextSelection}>
                                        <div className="absolute top-2 right-2 text-xs text-slate-300 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><Search size={12}/> 反白查單字</div>
                                        <h3 className="text-sm font-bold text-slate-400 uppercase mb-3 tracking-wider">Original Text</h3>
                                        <p className="text-lg leading-relaxed font-medium text-slate-800">{segments[currentSegmentIndex]}</p>
                                    </div>
                                    <div className="bg-amber-50 p-6 rounded-xl border border-amber-100">
                                        <h3 className="text-sm font-bold text-amber-600 uppercase mb-3 tracking-wider flex items-center gap-2"><Type size={16} /> Grammar Note</h3>
                                        <div className="text-amber-900"><span className="font-bold block mb-1">{data.grammar.title}</span><p className="text-sm opacity-90">{data.grammar.explanation}</p></div>
                                    </div>
                                    <details className="bg-slate-100 p-4 rounded-xl cursor-pointer group">
                                        <summary className="font-medium text-slate-600 flex items-center gap-2 select-none"><Languages size={16} /> 查看中文翻譯 <ChevronDown className="ml-auto group-open:rotate-180 transition-transform" size={16} /></summary>
                                        <p className="mt-3 text-slate-700 leading-relaxed border-t border-slate-200 pt-3">{data.translation}</p>
                                    </details>
                                </div>
                                <div className="space-y-4">
                                    <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2"><Award size={16} /> Key Vocabulary</h3>
                                    <div className="space-y-3">
                                        {data.vocab.map((word, idx) => (
                                            <div key={idx} className="bg-white p-4 rounded-lg shadow-sm border-l-4 border-blue-500 hover:shadow-md transition-shadow relative">
                                                <div className="flex justify-between items-baseline mb-1">
                                                    <span className="text-lg font-bold text-blue-700">{word.word}</span>
                                                    <span className="text-xs font-mono bg-slate-100 px-2 py-1 rounded text-slate-500">{word.pos}</span>
                                                </div>
                                                <p className="text-slate-800 font-medium">{word.meaning_zh}</p>
                                                <p className="text-sm text-slate-500 mt-1 italic">{word.note}</p>
                                                <button onClick={() => saveWord(word)} className="mt-2 text-xs text-blue-500 flex items-center gap-1 hover:underline"><Save size={12}/> 收藏</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            <div className="mt-8 flex justify-between pt-6 border-t border-slate-200">
                                <button 
                                    onClick={() => setCurrentSegmentIndex(prev => Math.max(0, prev - 1))}
                                    disabled={currentSegmentIndex === 0 || loading}
                                    className="flex items-center gap-2 text-slate-500 font-bold px-4 py-2 hover:bg-slate-200 rounded disabled:opacity-30"
                                >
                                    <ArrowLeft size={20} /> 上一段 (Prev)
                                </button>
                                
                                <button 
                                    onClick={() => setCurrentSegmentIndex(prev => Math.min(segments.length - 1, prev + 1))}
                                    disabled={loading}
                                    className="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold flex items-center gap-2 hover:bg-blue-700 disabled:opacity-50 shadow-lg"
                                >
                                    {currentSegmentIndex === segments.length - 1 ? "完成課程" : "下一段 (Next)"}
                                    <ArrowRight size={20} />
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (phase === 'vocab_bank') {
                return (
                    <div className="min-h-screen bg-slate-50 p-6">
                        <div className="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-8 min-h-[80vh]">
                            <header className="flex justify-between items-center mb-8 border-b pb-4">
                                <div className="flex items-center gap-3"><div className="bg-amber-100 p-3 rounded-lg"><BookOpen className="text-amber-600" size={28} /></div><h1 className="text-2xl font-bold text-slate-800">我的雲端單字庫</h1></div>
                                <button onClick={() => setPhase('setup')} className="text-slate-500 hover:text-blue-600 font-medium flex items-center gap-2"><ArrowLeft size={18} /> 返回</button>
                            </header>
                            {localVocab.length === 0 ? <div className="text-center py-16 text-slate-400"><List size={48} className="mx-auto mb-4 opacity-50" /><p>目前是空的，快去反白文章中的單字來收藏！</p></div> : (
                                <div className="grid gap-4 md:grid-cols-2">
                                    {localVocab.map((item) => (
                                        <div key={item.id} className="bg-white p-4 rounded-lg border border-slate-200 shadow-sm relative group">
                                            <button onClick={() => deleteWord(item.id)} className="absolute top-3 right-3 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><Trash2 size={18} /></button>
                                            <div className="flex items-baseline justify-between mb-1"><h3 className="text-xl font-bold text-blue-700">{item.word}</h3><span className="text-xs font-mono bg-slate-100 px-2 py-1 rounded text-slate-500">{item.pos}</span></div>
                                            <p className="text-slate-800 font-medium mb-1">{item.meaning_zh}</p>
                                            <p className="text-sm text-slate-500 italic">{item.note}</p>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            return null;
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<EnglishCramSchool />);
    </script>
</body>
</html>
