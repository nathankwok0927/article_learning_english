<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI English Tutor v2.1 (Auto-Save)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { BookOpen, CheckCircle, GraduationCap, ArrowRight, ArrowLeft, RefreshCcw, Type, Languages, Brain, ChevronDown, ChevronUp, ClipboardList, Award, Link as LinkIcon, Download, Save, Trash2, List, Settings, Key, Eye, EyeOff, Cloud, CloudLightning, Lock, Search, PlusCircle, AlertCircle, PlayCircle } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, collection, addDoc, deleteDoc, query, onSnapshot, setDoc, getDoc, doc } from 'firebase/firestore';

        // ⚠️ 請填入 Firebase 設定 (若無則使用本地模式)
        const firebaseConfig = {
            apiKey: "AIzaSyA14c5Rjzun6C33DWiMmpyKNfXZ2BC6lso",
            authDomain: "ai-english-tutor-f2a01.firebaseapp.com",
            projectId: "ai-english-tutor-f2a01",
            storageBucket: "ai-english-tutor-f2a01.firebasestorage.app",
            messagingSenderId: "404894794284",
            appId: "1:404894794284:web:28fa60b12a486715990789",
            measurementId: "G-6RC6GV81E3"
        };
        
        const APP_ID_TAG = "ai-tutor-v2";
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        const defaultApiKey = ""; 

        // --- API Helper ---
        async function generateContent(prompt, systemInstruction = "", userApiKey = null) {
            const keyToUse = userApiKey || defaultApiKey;
            if (!keyToUse) throw new Error("請先設定 Gemini API Key");

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${keyToUse}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };
            if (systemInstruction) payload.systemInstruction = { parts: [{ text: systemInstruction }] };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                return JSON.parse(text.replace(/^```json\s*/, '').replace(/\s*```$/, ''));
            } catch (error) {
                console.error("Gemini API Error:", error);
                throw new Error("連線錯誤或 API Key 無效");
            }
        }

        async function generateTextContent(prompt, userApiKey = null) {
            const keyToUse = userApiKey || defaultApiKey;
            if (!keyToUse) throw new Error("No API Key");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${keyToUse}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error("API Failed");
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
            } catch (error) { throw error; }
        }

        const LoadingSpinner = ({ text }) => (
            <div className="flex flex-col items-center justify-center py-12 text-blue-600 animate-pulse">
                <Brain size={48} className="mb-4" />
                <p className="text-lg font-medium font-sans">{text || "AI 導師正在思考中..."}</p>
            </div>
        );

        function EnglishCramSchool() {
            // --- Core State ---
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [localVocab, setLocalVocab] = useState([]); // Hybrid storage
            
            // App Logic State (Persistent targets)
            const [phase, setPhase] = useState('setup');
            const [userLevel, setUserLevel] = useState('HKDSE Level 2 (A2-B1)');
            const [articleText, setArticleText] = useState('');
            const [segments, setSegments] = useState([]);
            const [currentSegmentIndex, setCurrentSegmentIndex] = useState(0);
            const [segmentAnalyses, setSegmentAnalyses] = useState({});
            
            // UI State
            const [urlInput, setUrlInput] = useState('');
            const [userApiKey, setUserApiKey] = useState('');
            const [keyLoaded, setKeyLoaded] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [showApiKey, setShowApiKey] = useState(false);
            const [loading, setLoading] = useState(false);
            const [selection, setSelection] = useState(null);
            const [analyzingSelection, setAnalyzingSelection] = useState(false);
            const [savedSessionFound, setSavedSessionFound] = useState(false);

            // --- Initialization & Restore ---
            useEffect(() => {
                // 1. Load LocalStorage Settings/Data immediately
                const savedKey = localStorage.getItem('gemini_api_key');
                if (savedKey) { setUserApiKey(savedKey); setKeyLoaded(true); }

                const savedLocalVocab = localStorage.getItem('local_vocab_db');
                if (savedLocalVocab) setLocalVocab(JSON.parse(savedLocalVocab));

                // Check for saved session
                const savedSession = localStorage.getItem('current_session');
                if (savedSession) {
                    setSavedSessionFound(true);
                }

                // 2. Try Firebase (Might fail in restricted networks)
                try {
                    if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "你的_API_KEY") {
                        const app = initializeApp(firebaseConfig);
                        const auth = getAuth(app);
                        const firestore = getFirestore(app);
                        setDb(firestore);
                        signInAnonymously(auth).catch(e => console.warn("Firebase Auth blocked/failed", e));
                        onAuthStateChanged(auth, (u) => setUser(u));
                    }
                } catch (e) { console.warn("Firebase Init Skipped/Failed"); }
            }, []);

            // --- Auto-Save Logic ---
            useEffect(() => {
                if (phase === 'classroom' && articleText) {
                    const sessionData = {
                        phase, userLevel, articleText, segments, currentSegmentIndex, segmentAnalyses, timestamp: Date.now()
                    };
                    localStorage.setItem('current_session', JSON.stringify(sessionData));
                }
            }, [phase, userLevel, articleText, segments, currentSegmentIndex, segmentAnalyses]);

            const restoreSession = () => {
                const saved = localStorage.getItem('current_session');
                if (saved) {
                    const data = JSON.parse(saved);
                    // Check if data is not too old (e.g., < 24 hours) - Optional, here we assume user wants it
                    setPhase(data.phase);
                    setUserLevel(data.userLevel);
                    setArticleText(data.articleText);
                    setSegments(data.segments);
                    setCurrentSegmentIndex(data.currentSegmentIndex);
                    setSegmentAnalyses(data.segmentAnalyses);
                    setSavedSessionFound(false); // Hide alert
                }
            };

            const clearSession = () => {
                localStorage.removeItem('current_session');
                setSavedSessionFound(false);
                setArticleText('');
            };

            // --- Data Persistence (Hybrid) ---
            const saveApiKey = () => {
                localStorage.setItem('gemini_api_key', userApiKey);
                setKeyLoaded(true);
                setIsSettingsOpen(false);
                alert("API Key 已儲存在瀏覽器！");
            };

            const saveWord = async (wordData) => {
                const newWord = { ...wordData, id: Date.now().toString(), timestamp: Date.now() };
                
                // 1. Always save to LocalStorage (Backup)
                const updatedLocal = [newWord, ...localVocab];
                setLocalVocab(updatedLocal);
                localStorage.setItem('local_vocab_db', JSON.stringify(updatedLocal));

                // 2. Try Firebase if available
                if (user && db) {
                    try {
                        await addDoc(collection(db, 'artifacts', APP_ID_TAG, 'users', user.uid, 'vocabulary'), newWord);
                    } catch (e) { console.warn("Cloud save failed, using local only"); }
                }
            };

            const deleteWord = async (id) => {
                // 1. Delete Local
                const updated = localVocab.filter(w => w.id !== id);
                setLocalVocab(updated);
                localStorage.setItem('local_vocab_db', JSON.stringify(updated));

                // 2. Delete Firebase (if connected)
                if (user && db) {
                    try {
                        // This assumes ID matches document ID, which works for cloud-loaded items but tricky for mixed.
                        // For simplicity in this hybrid v2.1, we might just suppress cloud error if id not found.
                        await deleteDoc(doc(db, 'artifacts', APP_ID_TAG, 'users', user.uid, 'vocabulary', id));
                    } catch (e) {}
                }
            };

            // --- Load Vocab (Merge Cloud + Local) ---
            useEffect(() => {
                if (user && db) {
                    const q = collection(db, 'artifacts', APP_ID_TAG, 'users', user.uid, 'vocabulary');
                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        const cloudWords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        // Simple merge strategy: Cloud overwrites local for display if connected
                        if (cloudWords.length > 0) setLocalVocab(cloudWords);
                    });
                    return () => unsubscribe();
                }
            }, [user, db]);

            // --- Core Features ---

            const fetchArticle = async () => {
                if (!urlInput.trim()) return;
                setLoading(true);
                try {
                    // Try proxies
                    let html = null;
                    try { const r = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(urlInput)}`); if(r.ok) html = (await r.json()).contents; } catch(e){}
                    if(!html) { try { const r = await fetch(`https://corsproxy.io/?${encodeURIComponent(urlInput)}`); if(r.ok) html = await r.text(); } catch(e){} }
                    
                    if (!html) throw new Error("無法抓取，請手動複製");
                    
                    const text = await generateTextContent(`Extract clean article text from HTML: ${html.slice(0,100000)}`, userApiKey);
                    if(text.length < 50) throw new Error("提取失敗");
                    setArticleText(text.trim());
                } catch (e) { alert(e.message); }
                setLoading(false);
            };

            const startClass = () => {
                if (!articleText.trim()) return;
                const raw = articleText.split(/\n\s*\n/).filter(s => s.trim().length > 0);
                setSegments(raw);
                setPhase('classroom');
                setCurrentSegmentIndex(0);
                setSegmentAnalyses({});
                // Save new session triggers useEffect
            };

            const analyzeSegment = async () => {
                if (segmentAnalyses[currentSegmentIndex]) return;
                setLoading(true);
                try {
                    const prompt = `Analyze for ${userLevel}: "${segments[currentSegmentIndex]}". Return JSON: { "vocab": [{"word":"", "pos":"", "meaning_zh":"", "note":""}], "grammar": {"title":"", "explanation":""}, "translation": "" }`;
                    const res = await generateContent(prompt, "", userApiKey);
                    setSegmentAnalyses(prev => ({...prev, [currentSegmentIndex]: res}));
                } catch (e) { console.error(e); } // Keep UI active
                setLoading(false);
            };

            useEffect(() => {
                if (phase === 'classroom') analyzeSegment();
            }, [phase, currentSegmentIndex]);

            // Highlight
            const handleHighlight = () => {
                const s = window.getSelection();
                if (!s || s.isCollapsed) return;
                const text = s.toString().trim();
                if (text.length > 50 || text.length === 0) return setSelection(null);
                const rect = s.getRangeAt(0).getBoundingClientRect();
                setSelection({ text, x: rect.left + window.scrollX, y: rect.top + window.scrollY - 10 });
            };

            const saveHighlight = async () => {
                if(!selection) return;
                setAnalyzingSelection(true);
                try {
                    const res = await generateContent(`Define "${selection.text}" for ${userLevel}. Return JSON: {"word":"${selection.text}", "pos":"", "meaning_zh":"", "note":""}`, "", userApiKey);
                    await saveWord(res);
                    setSelection(null);
                } catch(e) { alert("分析失敗"); }
                setAnalyzingSelection(false);
            };

            // --- Views ---

            if (phase === 'setup') {
                return (
                    <div className="min-h-screen bg-slate-50 font-sans p-6 flex items-center justify-center">
                        <div className="max-w-3xl w-full bg-white rounded-xl shadow-lg p-8 border border-slate-200">
                            
                            {/* Saved Session Alert */}
                            {savedSessionFound && (
                                <div className="mb-6 bg-blue-50 border border-blue-200 p-4 rounded-lg flex items-center justify-between animate-in">
                                    <div className="flex items-center gap-3">
                                        <PlayCircle className="text-blue-600" />
                                        <div>
                                            <p className="font-bold text-blue-900">發現未完成的課程！</p>
                                            <p className="text-xs text-blue-700">你有上次未讀完的文章進度。</p>
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={clearSession} className="text-slate-500 hover:text-slate-700 text-sm px-3 py-1">放棄</button>
                                        <button onClick={restoreSession} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 shadow text-sm">繼續上課</button>
                                    </div>
                                </div>
                            )}

                            <div className="text-center mb-8 relative">
                                <div className="absolute top-0 right-0 flex gap-2">
                                    <button onClick={() => setIsSettingsOpen(!isSettingsOpen)} className={`text-sm px-3 py-1 rounded-full font-bold border flex items-center gap-2 ${keyLoaded ? 'bg-green-50 text-green-700 border-green-200' : 'bg-slate-100'}`}>
                                        {keyLoaded ? <CloudLightning size={14} /> : <Settings size={14} />} {keyLoaded ? "Ready" : "Set Key"}
                                    </button>
                                    <button onClick={() => setPhase('vocab_bank')} className="text-sm bg-amber-50 text-amber-800 border border-amber-200 px-3 py-1 rounded-full font-bold flex items-center gap-1">
                                        <BookOpen size={14} /> 單字庫
                                    </button>
                                </div>
                                <div className="bg-blue-100 p-3 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4"><GraduationCap size={32} className="text-blue-600" /></div>
                                <h1 className="text-3xl font-bold text-slate-800">AI 英文補習班 v2.1</h1>
                                <p className="text-slate-500 text-sm">Auto-Save & Hybrid Storage Enabled</p>
                            </div>

                            {isSettingsOpen && (
                                <div className="mb-6 bg-slate-900 text-white p-4 rounded-xl">
                                    <div className="flex gap-2 mb-2"><Key size={16} /> API Key (Browser Storage)</div>
                                    <input type={showApiKey?"text":"password"} value={userApiKey} onChange={e=>setUserApiKey(e.target.value)} className="w-full p-2 rounded bg-slate-800 text-sm mb-2" placeholder="Paste Gemini Key..." />
                                    <div className="flex justify-end gap-2">
                                        <button onClick={()=>setShowApiKey(!showApiKey)} className="text-xs text-slate-400">Show/Hide</button>
                                        <button onClick={saveApiKey} className="bg-blue-600 px-3 py-1 rounded text-sm">Save Local</button>
                                    </div>
                                </div>
                            )}

                            <div className="space-y-4">
                                <select value={userLevel} onChange={e=>setUserLevel(e.target.value)} className="w-full p-3 border rounded-lg"><option>HKDSE Level 2 (A2-B1)</option><option>HKDSE Level 3 (B1-B2)</option><option>HKDSE Level 4 (B2)</option></select>
                                <div className="flex gap-2">
                                    <input type="text" value={urlInput} onChange={e=>setUrlInput(e.target.value)} placeholder="https://..." className="flex-1 p-3 border rounded-lg" />
                                    <button onClick={fetchArticle} disabled={loading} className="bg-slate-200 px-4 rounded-lg">{loading?<RefreshCcw className="animate-spin"/>:<Download/>}</button>
                                </div>
                                <textarea value={articleText} onChange={e=>setArticleText(e.target.value)} className="w-full h-40 p-3 border rounded-lg font-mono text-sm" placeholder="Paste article here..." />
                                <button onClick={startClass} disabled={!articleText} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 disabled:bg-slate-300">Start Class</button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (phase === 'classroom') {
                const data = segmentAnalyses[currentSegmentIndex];
                return (
                    <div className="min-h-screen bg-slate-50 font-sans p-6" onClick={() => setSelection(null)}>
                        <div className="max-w-4xl mx-auto">
                            {/* Highlight Popup */}
                            {selection && (
                                <div className="fixed z-50 bg-slate-900 text-white p-2 rounded shadow-xl flex gap-2 -translate-x-1/2 -translate-y-full" style={{left:selection.x, top:selection.y}} onClick={e=>e.stopPropagation()}>
                                    <span className="font-bold border-r border-slate-600 pr-2">{selection.text}</span>
                                    <button onClick={saveHighlight} disabled={analyzingSelection} className="flex gap-1 items-center hover:text-blue-300">
                                        {analyzingSelection ? <RefreshCcw className="animate-spin" size={14}/> : <PlusCircle size={14}/>} Add
                                    </button>
                                </div>
                            )}

                            <header className="flex justify-between mb-4 border-b pb-4 items-center">
                                <h2 className="text-xl font-bold text-blue-900 flex gap-2"><Brain/> Classroom</h2>
                                <button onClick={()=>{setPhase('setup'); clearSession();}} className="text-xs text-red-400 hover:text-red-600">End Session</button>
                            </header>
                            
                            <div className="w-full bg-gray-200 h-2 rounded-full mb-6"><div className="bg-blue-600 h-2 rounded-full transition-all" style={{width:`${(currentSegmentIndex+1)/segments.length*100}%`}}></div></div>

                            {!data ? <LoadingSpinner/> : (
                                <div className="grid md:grid-cols-2 gap-6">
                                    <div className="space-y-4">
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 relative" onMouseUp={handleHighlight}>
                                            <p className="text-xs text-slate-300 absolute top-2 right-2 flex gap-1"><Search size={12}/> Highlight text to save</p>
                                            <p className="text-lg leading-relaxed text-slate-800 selection:bg-yellow-200">{segments[currentSegmentIndex]}</p>
                                        </div>
                                        <div className="bg-amber-50 p-4 rounded-xl border border-amber-100 text-amber-900">
                                            <h3 className="font-bold flex gap-2 text-sm uppercase mb-1"><Type size={16}/> Grammar</h3>
                                            <p className="font-bold">{data.grammar.title}</p>
                                            <p className="text-sm opacity-90">{data.grammar.explanation}</p>
                                        </div>
                                        <details className="bg-slate-100 p-3 rounded-lg"><summary className="cursor-pointer font-bold text-slate-600">Translation</summary><p className="mt-2 text-slate-700">{data.translation}</p></details>
                                    </div>
                                    <div className="space-y-3">
                                        <h3 className="font-bold text-slate-400 uppercase text-sm">Vocabulary</h3>
                                        {data.vocab.map((w,i)=>(
                                            <div key={i} className="bg-white p-3 rounded shadow-sm border-l-4 border-blue-500">
                                                <div className="flex justify-between font-bold text-blue-700"><span>{w.word}</span><span className="text-xs bg-slate-100 px-1 rounded text-slate-500 font-mono">{w.pos}</span></div>
                                                <p className="text-slate-800">{w.meaning_zh}</p>
                                                <p className="text-xs text-slate-500 italic">{w.note}</p>
                                                <button onClick={()=>saveWord(w)} className="text-xs mt-2 text-blue-500 hover:underline flex gap-1 items-center"><Save size={12}/> Save to Bank</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            <div className="mt-8 flex justify-between pt-6 border-t">
                                <button onClick={()=>setCurrentSegmentIndex(p=>Math.max(0, p-1))} disabled={currentSegmentIndex===0} className="flex gap-2 items-center text-slate-500 font-bold disabled:opacity-30"><ArrowLeft/> Previous</button>
                                <button onClick={()=>setCurrentSegmentIndex(p=>Math.min(segments.length-1, p+1))} disabled={currentSegmentIndex===segments.length-1} className="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold flex gap-2 items-center hover:bg-blue-700 disabled:opacity-50">Next <ArrowRight/></button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (phase === 'vocab_bank') {
                return (
                    <div className="min-h-screen bg-slate-50 p-6">
                        <div className="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg">
                            <header className="flex justify-between mb-6 pb-4 border-b">
                                <h1 className="text-2xl font-bold flex gap-2 items-center"><BookOpen className="text-amber-600"/> My Vocab Bank</h1>
                                <button onClick={()=>setPhase('setup')} className="flex gap-2 items-center text-slate-500 font-bold"><ArrowLeft/> Back</button>
                            </header>
                            {localVocab.length === 0 ? <p className="text-center text-slate-400 py-10">單字庫是空的 (Local Storage)</p> : (
                                <div className="grid md:grid-cols-2 gap-4">
                                    {localVocab.map((w, i)=>(
                                        <div key={i} className="border p-4 rounded-lg relative group hover:shadow-md transition-shadow">
                                            <button onClick={()=>deleteWord(w.id)} className="absolute top-2 right-2 text-slate-300 hover:text-red-500"><Trash2 size={16}/></button>
                                            <h3 className="font-bold text-lg text-blue-700">{w.word} <span className="text-xs text-slate-400 font-normal">{w.pos}</span></h3>
                                            <p>{w.meaning_zh}</p>
                                            <p className="text-xs text-slate-500 italic">{w.note}</p>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            return null;
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<EnglishCramSchool />);
    </script>
</body>
</html>
