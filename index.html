<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI English Tutor v2.2 (Ultimate)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .animate-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased selection:bg-blue-100 selection:text-blue-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { BookOpen, CheckCircle, GraduationCap, ArrowRight, ArrowLeft, RefreshCcw, Type, Languages, Brain, ChevronDown, ChevronUp, ClipboardList, Award, Link as LinkIcon, Download, Save, Trash2, List, Settings, Key, Eye, EyeOff, Cloud, CloudLightning, Lock, Search, PlusCircle, AlertCircle, PlayCircle, X } from 'lucide-react';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, collection, addDoc, deleteDoc, query, onSnapshot, setDoc, getDoc, doc } from 'firebase/firestore';

        // ⚠️ FIREBASE CONFIG (若無則使用 LocalStorage 模式)
        const firebaseConfig = {
            apiKey: "AIzaSyA14c5Rjzun6C33DWiMmpyKNfXZ2BC6lso",
            authDomain: "ai-english-tutor-f2a01.firebaseapp.com",
            projectId: "ai-english-tutor-f2a01",
            storageBucket: "ai-english-tutor-f2a01.firebasestorage.app",
            messagingSenderId: "404894794284",
            appId: "1:404894794284:web:28fa60b12a486715990789",
            measurementId: "G-6RC6GV81E3"
        };
        
        const APP_ID_TAG = "ai-tutor-v2";
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        const defaultApiKey = ""; 

        // --- API Helper (Strict Mode) ---
        async function generateContent(prompt, systemInstruction = "", userApiKey = null, temperature = 0.7) {
            const keyToUse = userApiKey || defaultApiKey;
            if (!keyToUse) throw new Error("請先設定 Gemini API Key");

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${keyToUse}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: { 
                    responseMimeType: "application/json",
                    temperature: temperature // Control creativity
                }
            };
            if (systemInstruction) payload.systemInstruction = { parts: [{ text: systemInstruction }] };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                return JSON.parse(text.replace(/^```json\s*/, '').replace(/\s*```$/, ''));
            } catch (error) {
                console.error("Gemini API Error:", error);
                throw error;
            }
        }

        async function generateTextContent(prompt, userApiKey = null) {
            const keyToUse = userApiKey || defaultApiKey;
            if (!keyToUse) throw new Error("No API Key");
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${keyToUse}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.1 } // Low temp for extraction accuracy
                    })
                });
                if (!response.ok) throw new Error("API Failed");
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
            } catch (error) { throw error; }
        }

        const LoadingSpinner = ({ text }) => (
            <div className="flex flex-col items-center justify-center py-12 text-blue-600 animate-pulse">
                <div className="relative">
                    <div className="w-12 h-12 border-4 border-blue-200 rounded-full"></div>
                    <div className="w-12 h-12 border-4 border-blue-600 rounded-full border-t-transparent absolute top-0 left-0 animate-spin"></div>
                </div>
                <p className="mt-4 text-lg font-medium font-sans text-slate-600">{text || "AI 導師正在備課中..."}</p>
            </div>
        );

        function EnglishCramSchool() {
            // --- Core State ---
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [localVocab, setLocalVocab] = useState([]); 
            
            // Persistent State
            const [phase, setPhase] = useState('setup');
            const [userLevel, setUserLevel] = useState('HKDSE Level 2 (A2-B1)');
            const [articleText, setArticleText] = useState('');
            const [segments, setSegments] = useState([]);
            const [currentSegmentIndex, setCurrentSegmentIndex] = useState(0);
            const [segmentAnalyses, setSegmentAnalyses] = useState({});
            
            // UI State
            const [urlInput, setUrlInput] = useState('');
            const [userApiKey, setUserApiKey] = useState('');
            const [keyLoaded, setKeyLoaded] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [showApiKey, setShowApiKey] = useState(false);
            const [loading, setLoading] = useState(false);
            const [selection, setSelection] = useState(null);
            const [analyzingSelection, setAnalyzingSelection] = useState(false);
            const [savedSessionFound, setSavedSessionFound] = useState(false);

            // --- Init & Restore ---
            useEffect(() => {
                const savedKey = localStorage.getItem('gemini_api_key');
                if (savedKey) { setUserApiKey(savedKey); setKeyLoaded(true); }

                const savedLocalVocab = localStorage.getItem('local_vocab_db');
                if (savedLocalVocab) setLocalVocab(JSON.parse(savedLocalVocab));

                const savedSession = localStorage.getItem('current_session');
                if (savedSession) setSavedSessionFound(true);

                try {
                    if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "你的_API_KEY") {
                        const app = initializeApp(firebaseConfig);
                        const auth = getAuth(app);
                        const firestore = getFirestore(app);
                        setDb(firestore);
                        signInAnonymously(auth).catch(e => console.warn("Firebase Auth blocked/failed", e));
                        onAuthStateChanged(auth, (u) => setUser(u));
                    }
                } catch (e) { console.warn("Firebase Init Skipped"); }
            }, []);

            // --- Auto-Save ---
            useEffect(() => {
                if (phase === 'classroom' && articleText) {
                    const sessionData = {
                        phase, userLevel, articleText, segments, currentSegmentIndex, segmentAnalyses, timestamp: Date.now()
                    };
                    localStorage.setItem('current_session', JSON.stringify(sessionData));
                }
            }, [phase, userLevel, articleText, segments, currentSegmentIndex, segmentAnalyses]);

            const restoreSession = () => {
                const saved = localStorage.getItem('current_session');
                if (saved) {
                    const data = JSON.parse(saved);
                    setPhase(data.phase);
                    setUserLevel(data.userLevel);
                    setArticleText(data.articleText);
                    setSegments(data.segments);
                    setCurrentSegmentIndex(data.currentSegmentIndex);
                    setSegmentAnalyses(data.segmentAnalyses);
                    setSavedSessionFound(false);
                }
            };

            const clearSession = () => {
                localStorage.removeItem('current_session');
                setSavedSessionFound(false);
                setArticleText('');
            };

            // --- Persistence ---
            const saveApiKey = () => {
                localStorage.setItem('gemini_api_key', userApiKey);
                setKeyLoaded(true);
                setIsSettingsOpen(false);
                alert("API Key 已儲存 (Local)！");
            };

            const saveWord = async (wordData) => {
                const newWord = { ...wordData, id: Date.now().toString(), timestamp: Date.now() };
                const updatedLocal = [newWord, ...localVocab];
                setLocalVocab(updatedLocal);
                localStorage.setItem('local_vocab_db', JSON.stringify(updatedLocal));

                if (user && db) {
                    try { await addDoc(collection(db, 'artifacts', APP_ID_TAG, 'users', user.uid, 'vocabulary'), newWord); } 
                    catch (e) { console.warn("Cloud save failed"); }
                }
            };

            const deleteWord = async (id) => {
                const updated = localVocab.filter(w => w.id !== id);
                setLocalVocab(updated);
                localStorage.setItem('local_vocab_db', JSON.stringify(updated));
                if (user && db) {
                    try { await deleteDoc(doc(db, 'artifacts', APP_ID_TAG, 'users', user.uid, 'vocabulary', id)); } catch(e){}
                }
            };

            // Sync Cloud Vocab
            useEffect(() => {
                if (user && db) {
                    const q = collection(db, 'artifacts', APP_ID_TAG, 'users', user.uid, 'vocabulary');
                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        const cloudWords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        if (cloudWords.length > 0) setLocalVocab(cloudWords);
                    });
                    return () => unsubscribe();
                }
            }, [user, db]);

            // --- Features ---

            const fetchArticle = async () => {
                if (!urlInput.trim()) return;
                setLoading(true);
                try {
                    let html = null;
                    try { const r = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(urlInput)}`); if(r.ok) html = (await r.json()).contents; } catch(e){}
                    if(!html) { try { const r = await fetch(`https://corsproxy.io/?${encodeURIComponent(urlInput)}`); if(r.ok) html = await r.text(); } catch(e){} }
                    
                    if (!html) throw new Error("Proxy Blocked: 無法抓取，請手動複製網頁文字。");
                    
                    // CRITICAL FIX: Strict Extraction Prompt
                    const prompt = `
                        You are a strict HTML content extractor. 
                        Your task: Extract the MAIN article body text from the provided HTML.
                        RULES:
                        1. Do NOT summarize. Do NOT rewrite. Do NOT simplify.
                        2. Keep the original sentences exactly as they are.
                        3. Remove ads, navigation menus, footers, and sidebars.
                        4. Return ONLY the plain text.
                        
                        HTML Source: ${html.slice(0, 100000)}
                    `;
                    
                    const text = await generateTextContent(prompt, userApiKey);
                    if(text.length < 50) throw new Error("內容過短");
                    setArticleText(text.trim());
                } catch (e) { alert(e.message); }
                setLoading(false);
            };

            const startClass = () => {
                if (!articleText.trim()) return;
                const raw = articleText.split(/\n\s*\n/).filter(s => s.trim().length > 0);
                setSegments(raw);
                setPhase('classroom');
                setCurrentSegmentIndex(0);
                setSegmentAnalyses({});
            };

            const analyzeSegment = async () => {
                if (segmentAnalyses[currentSegmentIndex]) return;
                setLoading(true);
                try {
                    const prompt = `Analyze for ${userLevel}: "${segments[currentSegmentIndex]}". Return JSON: { "vocab": [{"word":"", "pos":"", "meaning_zh":"", "note":""}], "grammar": {"title":"", "explanation":""}, "translation": "" }. Select 3-5 difficult words.`;
                    const res = await generateContent(prompt, "", userApiKey, 0.7);
                    setSegmentAnalyses(prev => ({...prev, [currentSegmentIndex]: res}));
                } catch (e) { console.error(e); }
                setLoading(false);
            };

            useEffect(() => { if (phase === 'classroom') analyzeSegment(); }, [phase, currentSegmentIndex]);

            // Highlight Logic
            const handleHighlight = () => {
                const s = window.getSelection();
                if (!s || s.isCollapsed) return;
                const text = s.toString().trim();
                if (text.length > 50 || text.length === 0) return setSelection(null);
                
                // Get absolute position relative to document
                const range = s.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
                const scrollY = window.pageYOffset || document.documentElement.scrollTop;

                setSelection({ 
                    text, 
                    x: rect.left + scrollX + (rect.width / 2), 
                    y: rect.top + scrollY - 10 
                });
            };

            const saveHighlight = async () => {
                if(!selection) return;
                setAnalyzingSelection(true);
                try {
                    const res = await generateContent(`Define "${selection.text}" for ${userLevel}. Return JSON: {"word":"${selection.text}", "pos":"", "meaning_zh":"", "note":""}`, "", userApiKey, 0.2);
                    await saveWord(res);
                    setSelection(null);
                } catch(e) { alert("分析失敗，請重試"); }
                setAnalyzingSelection(false);
            };

            // --- Views ---

            if (phase === 'setup') {
                return (
                    <div className="min-h-screen bg-slate-50 flex items-center justify-center p-6">
                        <div className="max-w-3xl w-full bg-white rounded-2xl shadow-xl p-8 border border-slate-100">
                            
                            {savedSessionFound && (
                                <div className="mb-8 bg-blue-50 border border-blue-100 p-4 rounded-xl flex items-center justify-between animate-in">
                                    <div className="flex items-center gap-3">
                                        <div className="bg-blue-100 p-2 rounded-full"><PlayCircle className="text-blue-600" size={20} /></div>
                                        <div>
                                            <p className="font-bold text-blue-900">發現未完成的課程</p>
                                            <p className="text-xs text-blue-600">系統自動保存了你上次的進度。</p>
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={clearSession} className="text-slate-400 hover:text-slate-600 text-sm px-3 font-medium transition-colors">放棄</button>
                                        <button onClick={restoreSession} className="bg-blue-600 text-white px-5 py-2 rounded-lg font-bold hover:bg-blue-700 shadow-md shadow-blue-200 transition-all transform hover:-translate-y-0.5">繼續上課</button>
                                    </div>
                                </div>
                            )}

                            <div className="text-center mb-10 relative">
                                <div className="absolute top-0 right-0 flex gap-2">
                                    <button onClick={() => setIsSettingsOpen(!isSettingsOpen)} className={`text-xs px-3 py-1.5 rounded-full font-bold border transition-all flex items-center gap-1.5 ${keyLoaded ? 'bg-emerald-50 text-emerald-700 border-emerald-200' : 'bg-slate-50 text-slate-600 border-slate-200 hover:bg-slate-100'}`}>
                                        {keyLoaded ? <Lock size={12} /> : <Settings size={12} />} {keyLoaded ? "API Ready" : "Set Key"}
                                    </button>
                                    {user && <button onClick={() => setPhase('vocab_bank')} className="text-xs bg-amber-50 text-amber-700 border border-amber-200 px-3 py-1.5 rounded-full font-bold hover:bg-amber-100 transition-colors flex items-center gap-1.5"><BookOpen size={12} /> 單字庫</button>}
                                </div>
                                <div className="bg-gradient-to-br from-blue-100 to-indigo-100 p-4 rounded-2xl w-20 h-20 flex items-center justify-center mx-auto mb-5 shadow-inner">
                                    <GraduationCap size={40} className="text-blue-600" />
                                </div>
                                <h1 className="text-3xl font-extrabold text-slate-800 mb-2 tracking-tight">AI 英文補習班 <span className="text-blue-600">v2.2</span></h1>
                                <p className="text-slate-500 font-medium">Auto-Save • Precise Extraction • Hybrid Storage</p>
                            </div>

                            {isSettingsOpen && (
                                <div className="mb-8 bg-slate-800 text-white p-5 rounded-2xl animate-in shadow-2xl relative overflow-hidden">
                                    <div className="relative z-10">
                                        <div className="flex gap-2 items-center mb-3 text-amber-400 font-bold"><Key size={18} /> API Key 設定</div>
                                        <p className="text-xs text-slate-400 mb-3">Key 將加密儲存於您的瀏覽器 (Local Storage)，不會上傳至伺服器。</p>
                                        <div className="relative">
                                            <input type={showApiKey?"text":"password"} value={userApiKey} onChange={e=>setUserApiKey(e.target.value)} className="w-full p-3 rounded-lg bg-slate-900 border border-slate-700 text-sm focus:ring-2 focus:ring-amber-400 outline-none font-mono" placeholder="貼上 Google Gemini API Key..." />
                                            <button onClick={()=>setShowApiKey(!showApiKey)} className="absolute right-3 top-3 text-slate-500 hover:text-white"><Eye size={16}/></button>
                                        </div>
                                        <div className="flex justify-end gap-3 mt-4">
                                            <button onClick={()=>setIsSettingsOpen(false)} className="text-slate-400 hover:text-white text-sm">取消</button>
                                            <button onClick={saveApiKey} className="bg-amber-500 hover:bg-amber-600 text-black font-bold px-4 py-2 rounded-lg text-sm shadow-lg transition-all">儲存設定</button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div className="space-y-5">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">你的程度 (Level)</label>
                                    <select value={userLevel} onChange={e=>setUserLevel(e.target.value)} className="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all font-medium text-slate-700">
                                        <option>HKDSE Level 2 (A2-B1)</option>
                                        <option>HKDSE Level 3 (B1-B2)</option>
                                        <option>HKDSE Level 4 (B2)</option>
                                        <option>HKDSE Level 5+ (C1)</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">匯入文章 (Import)</label>
                                    <div className="flex gap-2">
                                        <input type="text" value={urlInput} onChange={e=>setUrlInput(e.target.value)} placeholder="https://www.bbc.com/news/..." className="flex-1 p-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all text-sm" />
                                        <button onClick={fetchArticle} disabled={loading} className="bg-white border border-slate-200 text-slate-600 px-5 rounded-xl font-bold hover:bg-slate-50 hover:text-blue-600 transition-all flex items-center gap-2 shadow-sm">
                                            {loading ? <RefreshCcw className="animate-spin" size={18}/> : <Download size={18}/>} 抓取
                                        </button>
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">或貼上內容 (Paste Content)</label>
                                    <textarea value={articleText} onChange={e=>setArticleText(e.target.value)} className="w-full h-48 p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none resize-none font-mono text-sm leading-relaxed" placeholder="在此貼上任何英文文章..." />
                                </div>

                                <button onClick={startClass} disabled={!articleText.trim()} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-blue-700 hover:shadow-blue-200 hover:-translate-y-0.5 active:translate-y-0 disabled:opacity-50 disabled:cursor-not-allowed transition-all flex justify-center items-center gap-2">
                                    <BookOpen size={22} /> 開始上課 (Start Class)
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (phase === 'classroom') {
                const data = segmentAnalyses[currentSegmentIndex];
                return (
                    <div className="min-h-screen bg-slate-50 font-sans p-6 pb-24" onClick={() => setSelection(null)}>
                        <div className="max-w-5xl mx-auto">
                            
                            {/* Highlight Action Menu */}
                            {selection && (
                                <div 
                                    className="fixed z-50 bg-slate-800 text-white p-2 rounded-lg shadow-2xl flex items-center gap-3 animate-in"
                                    style={{ left: selection.x, top: selection.y, transform: 'translate(-50%, -120%)' }}
                                    onClick={e => e.stopPropagation()}
                                >
                                    <span className="font-bold text-sm px-2 border-r border-slate-600 max-w-[150px] truncate">{selection.text}</span>
                                    <button 
                                        onClick={saveHighlight} 
                                        disabled={analyzingSelection}
                                        className="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1.5 rounded-md font-bold flex items-center gap-1.5 transition-colors"
                                    >
                                        {analyzingSelection ? <RefreshCcw className="animate-spin" size={12}/> : <PlusCircle size={14}/>} 
                                        解釋並收藏
                                    </button>
                                </div>
                            )}

                            <header className="flex justify-between items-center mb-8">
                                <div className="flex items-center gap-3">
                                    <div className="bg-white p-2 rounded-lg shadow-sm border border-slate-100">
                                        <Brain className="text-blue-600" size={24} />
                                    </div>
                                    <h2 className="text-xl font-bold text-slate-800">Classroom</h2>
                                </div>
                                <button onClick={()=>{setPhase('setup'); clearSession();}} className="text-slate-400 hover:text-red-500 font-medium text-sm flex items-center gap-1 transition-colors">
                                    <X size={16} /> End Session
                                </button>
                            </header>
                            
                            <div className="w-full bg-slate-200 h-2.5 rounded-full mb-8 overflow-hidden">
                                <div className="bg-blue-600 h-full rounded-full transition-all duration-500 ease-out" style={{width:`${(currentSegmentIndex+1)/segments.length*100}%`}}></div>
                            </div>

                            {!data ? (
                                <LoadingSpinner text="AI 老師正在分析段落..." />
                            ) : (
                                <div className="grid lg:grid-cols-2 gap-8">
                                    {/* Left: Text & Grammar */}
                                    <div className="space-y-6">
                                        <div 
                                            className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200 relative group transition-all hover:shadow-md"
                                            onMouseUp={handleHighlight}
                                        >
                                            <div className="absolute top-4 right-4 bg-slate-100 text-slate-400 text-xs px-2 py-1 rounded-full flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                                <Search size={10} /> 反白單字可查詢
                                            </div>
                                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Original Text</h3>
                                            <p className="text-xl leading-relaxed text-slate-800 font-medium selection:bg-amber-200 selection:text-amber-900">
                                                {segments[currentSegmentIndex]}
                                            </p>
                                        </div>

                                        <div className="bg-gradient-to-br from-amber-50 to-orange-50 p-6 rounded-2xl border border-amber-100 text-amber-900 shadow-sm">
                                            <h3 className="font-bold flex items-center gap-2 text-xs uppercase tracking-widest mb-3 opacity-70">
                                                <Type size={14}/> Grammar Focus
                                            </h3>
                                            <p className="font-bold text-lg mb-2">{data.grammar.title}</p>
                                            <p className="opacity-90 leading-relaxed">{data.grammar.explanation}</p>
                                        </div>

                                        <details className="bg-slate-100 rounded-xl overflow-hidden border border-slate-200">
                                            <summary className="p-4 cursor-pointer font-bold text-slate-600 flex items-center gap-2 hover:bg-slate-200 transition-colors select-none">
                                                <Languages size={18} /> 查看中文翻譯 (Translation)
                                                <ChevronDown className="ml-auto opacity-50" size={18} />
                                            </summary>
                                            <div className="p-4 pt-0 text-slate-700 leading-relaxed border-t border-slate-200/50 mt-2">
                                                {data.translation}
                                            </div>
                                        </details>
                                    </div>

                                    {/* Right: Vocab */}
                                    <div className="space-y-4">
                                        <div className="flex items-center justify-between mb-2">
                                            <h3 className="font-bold text-slate-400 text-xs uppercase tracking-widest flex items-center gap-2">
                                                <Award size={14} /> Key Vocabulary
                                            </h3>
                                            <span className="text-xs font-bold bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">{data.vocab.length} words</span>
                                        </div>
                                        <div className="space-y-3">
                                            {data.vocab.map((w, i) => (
                                                <div key={i} className="bg-white p-5 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition-all group relative">
                                                    <div className="flex justify-between items-baseline mb-1">
                                                        <h4 className="text-xl font-bold text-blue-700">{w.word}</h4>
                                                        <span className="text-xs font-mono bg-slate-100 text-slate-500 px-2 py-1 rounded">{w.pos}</span>
                                                    </div>
                                                    <p className="text-slate-800 font-medium mb-1">{w.meaning_zh}</p>
                                                    <p className="text-sm text-slate-500 italic mb-3">{w.note}</p>
                                                    <button 
                                                        onClick={() => saveWord(w)}
                                                        className="w-full py-2 rounded-lg bg-blue-50 text-blue-600 text-xs font-bold hover:bg-blue-600 hover:text-white transition-all flex justify-center items-center gap-1.5 opacity-0 group-hover:opacity-100"
                                                    >
                                                        <Save size={14} /> Save to Bank
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Sticky Footer Navigation */}
                            <div className="fixed bottom-0 left-0 w-full bg-white/90 backdrop-blur-md border-t border-slate-200 p-4 shadow-lg z-40">
                                <div className="max-w-4xl mx-auto flex justify-between items-center">
                                    <button 
                                        onClick={() => setCurrentSegmentIndex(prev => Math.max(0, prev - 1))}
                                        disabled={currentSegmentIndex === 0 || loading}
                                        className="flex items-center gap-2 px-6 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-100 disabled:opacity-30 disabled:hover:bg-transparent transition-all"
                                    >
                                        <ArrowLeft size={20} /> 上一段 (Prev)
                                    </button>

                                    <span className="text-sm font-mono font-medium text-slate-400">
                                        Segment {currentSegmentIndex + 1} of {segments.length}
                                    </span>

                                    <button 
                                        onClick={() => setCurrentSegmentIndex(prev => Math.min(segments.length - 1, prev + 1))}
                                        disabled={currentSegmentIndex === segments.length - 1 || loading}
                                        className="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 hover:-translate-y-0.5 active:translate-y-0 disabled:opacity-50 disabled:shadow-none transition-all flex items-center gap-2"
                                    >
                                        {currentSegmentIndex === segments.length - 1 ? "進入測驗 (Quiz)" : "下一段 (Next)"}
                                        <ArrowRight size={20} />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (phase === 'vocab_bank') {
                return (
                    <div className="min-h-screen bg-slate-50 p-6 font-sans">
                        <div className="max-w-5xl mx-auto bg-white p-8 rounded-2xl shadow-xl border border-slate-100 min-h-[80vh]">
                            <header className="flex justify-between items-center mb-8 pb-6 border-b border-slate-100">
                                <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-3">
                                    <div className="bg-amber-100 p-2 rounded-lg"><BookOpen className="text-amber-600" size={24} /></div>
                                    我的單字庫 (My Vocab Bank)
                                </h1>
                                <button onClick={() => setPhase('setup')} className="text-slate-500 hover:text-blue-600 font-bold flex items-center gap-2 transition-colors px-4 py-2 hover:bg-slate-50 rounded-lg">
                                    <ArrowLeft size={20} /> Back to Home
                                </button>
                            </header>

                            {localVocab.length === 0 ? (
                                <div className="text-center py-20">
                                    <div className="bg-slate-50 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <List size={48} className="text-slate-300" />
                                    </div>
                                    <p className="text-slate-500 font-medium">單字庫還是空的</p>
                                    <p className="text-slate-400 text-sm mt-2">快去上課或反白文章中的單字來新增吧！</p>
                                </div>
                            ) : (
                                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {localVocab.map((w, i) => (
                                        <div key={i} className="border border-slate-100 bg-white p-5 rounded-xl relative group hover:shadow-lg hover:border-blue-200 transition-all">
                                            <button 
                                                onClick={() => deleteWord(w.id)} 
                                                className="absolute top-3 right-3 text-slate-300 hover:text-red-500 hover:bg-red-50 p-1 rounded-md transition-all opacity-0 group-hover:opacity-100"
                                            >
                                                <Trash2 size={16} />
                                            </button>
                                            <div className="flex items-baseline gap-2 mb-2">
                                                <h3 className="font-bold text-lg text-blue-700">{w.word}</h3>
                                                <span className="text-xs font-mono bg-slate-50 px-1.5 py-0.5 rounded text-slate-400">{w.pos}</span>
                                            </div>
                                            <p className="text-slate-800 font-medium mb-1 line-clamp-1" title={w.meaning_zh}>{w.meaning_zh}</p>
                                            <p className="text-xs text-slate-500 italic line-clamp-2 h-8" title={w.note}>{w.note}</p>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            return null;
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<EnglishCramSchool />);
    </script>
</body>
</html>
